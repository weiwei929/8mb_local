services:
  8mblocal:
    image: jms1717/8mblocal:latest
    container_name: 8mblocal
    ports:
      - "8001:8001"
    volumes:
      - ./uploads:/app/uploads
      - ./outputs:/app/outputs
      - ./.env:/app/.env  # optional custom settings
    environment:
      - REDIS_URL=redis://127.0.0.1:6379/0
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,video,utility
      # Intel VAAPI/QSV: ensure VA driver selection
      - LIBVA_DRIVER_NAME=iHD
    # Enable NVIDIA GPUs with Compose
    gpus: all
    # Enable NVIDIA GPU acceleration (Docker Desktop / Linux with nvidia-container-toolkit)
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
  # Optional: enable VAAPI/QSV on Linux (Intel/AMD) - uncomment on bare-metal Linux hosts
  # devices:
  #   - "/dev/dri:/dev/dri"
    restart: unless-stopped
